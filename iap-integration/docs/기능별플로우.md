# IAP Integration 기능별 플로우

## 1. 구독 검증 플로우

### 1.1 Google Play (AOS) 구독 검증

1. 클라이언트(Android 앱)에서 구독 검증 요청을 서버로 전송
   - 필요 정보: 상품 ID, 구매 토큰, 패키지명
2. 서버에서 요청 파라미터 검증 (패키지명은 필수)
3. Google Play 플랫폼 어댑터를 통해 구글 API 호출
   - API 엔드포인트: `https://androidpublisher.googleapis.com/androidpublisher/v3/applications/{packageName}/purchases/subscriptionsv2/tokens/{token}`
   - 참고 문서: https://developers.google.com/android-publisher/api-ref/rest/v3/purchases.subscriptionsv2/get
4. 구글로부터 받은 구독 데이터를 내부 도메인 모델로 변환
   - 구독 상태 매핑 (SUBSCRIPTION_STATE_ACTIVE → ACTIVE 등)
   - 시작일, 만료일, 자동갱신 여부 등 추출
5. 검증된 구독 정보를 데이터베이스에 저장
6. 클라이언트에게 검증 결과 응답

**주요 처리사항**:
- JWT 토큰 기반 OAuth 2.0 인증 필요
- 구글 플레이 구독 상태별 비즈니스 로직 적용
- API 호출 실패 시 적절한 에러 메시지 반환

### 1.2 App Store (iOS) 구독 검증

1. 클라이언트(iOS 앱)에서 구독 검증 요청을 서버로 전송
   - 필요 정보: 상품 ID, 거래 ID, 번들 ID
2. 서버에서 요청 파라미터 검증 (번들 ID는 필수)
3. App Store 플랫폼 어댑터를 통해 애플 API 호출
   - API 엔드포인트: App Store Server API를 통한 거래 정보 조회
   - 참고 문서: https://developer.apple.com/documentation/appstoreserverapi/get-transaction-info
   - 프로덕션: `https://api.storekit.itunes.apple.com`
   - 샌드박스: `https://api.storekit-sandbox.itunes.apple.com`
4. 애플로부터 받은 JWT 형태의 거래 정보를 디코딩하여 도메인 모델로 변환
5. 검증된 구독 정보를 데이터베이스에 저장
6. 클라이언트에게 검증 결과 응답

**주요 처리사항**:
- App Store Connect에서 생성한 JWT 토큰 필요
- 환경별(sandbox/production) API 엔드포인트 구분
- JWT 토큰 디코딩 및 검증 로직 필요

---

## 2. 결제 승인 플로우

### 2.1 Google Play (AOS) 결제 승인

1. 클라이언트에서 결제 승인 요청을 서버로 전송
2. 서버에서 구글 플레이 API를 통해 구독 승인 처리
   - API 엔드포인트: `https://androidpublisher.googleapis.com/androidpublisher/v3/applications/{packageName}/purchases/subscriptions/{subscriptionId}/tokens/{token}:acknowledge`
   - 참고 문서: https://developers.google.com/android-publisher/api-ref/rest/v3/purchases.subscriptions/acknowledge
   - 참고: subscriptionsv2는 조회용이며, 승인은 여전히 기존 subscriptions 엔드포인트 사용
3. 구글로부터 승인 완료 응답 수신
4. 내부적으로 결제(Payment) 엔티티 생성 및 저장
5. 클라이언트에게 승인 완료 응답

**중요 사항**:
- 구글 플레이는 반드시 3일 이내에 승인 처리 필요
- 미처리 시 자동으로 환불됨
- OAuth 2.0 서비스 계정 인증 필요

### 2.2 App Store (iOS) 결제 승인

1. 클라이언트에서 결제 승인 요청을 서버로 전송
2. App Store는 별도의 승인 API가 없어 검증 과정에서 자동 승인됨
3. 내부적으로 결제(Payment) 엔티티 생성 및 저장
4. 클라이언트에게 승인 완료 응답

**중요 사항**:
- 영수증 검증이 곧 결제 승인을 의미함
- 클라이언트 측에서 StoreKit의 finishTransaction 호출 필요
- 서버 측 승인 API가 별도로 없음

---

## 3. 환불 처리 플로우

### 3.1 Google Play (AOS) 환불 처리

1. 관리자 또는 고객이 환불 요청을 시스템에 등록
   - 필요 정보: 결제 ID, 환불 금액, 환불 사유
2. 환불 요청 상태를 '요청됨(REQUESTED)'으로 설정하여 저장
3. 관리자가 환불 요청을 검토 후 승인 또는 거부 결정
4. 승인된 환불에 대해 자동 또는 수동으로 처리 시작
5. 구글 플레이 API를 통해 실제 환불 처리
   - API 엔드포인트: `https://androidpublisher.googleapis.com/androidpublisher/v3/applications/{packageName}/orders/{orderId}:refund?revoke=true`
   - 참고 문서: https://developers.google.com/android-publisher/api-ref/rest/v3/orders/refund
6. 구글로부터 환불 처리 완료 응답 수신
7. 환불 상태를 '완료됨(COMPLETED)'으로 업데이트
8. 관련 구독 상태도 함께 업데이트 (필요시)

**처리 시간**: 1-3 영업일  
**중요 사항**:
- `revoke=true` 파라미터로 구독 취소까지 동시 처리 가능
- 구글 플레이 콘솔에서도 환불 내역 확인 가능
- 부분 환불도 지원됨

### 3.2 App Store (iOS) 환불 처리

1. 관리자 또는 고객이 환불 요청을 시스템에 등록
2. 환불 요청 상태를 '요청됨(REQUESTED)'으로 설정하여 저장
3. 관리자가 환불 요청을 검토 후 승인 또는 거부 결정
4. 승인된 환불에 대해 App Store Server API로 환불 이력 조회 시도
   - API 엔드포인트: App Store Server API를 통한 환불 이력 조회
   - 참고 문서: https://developer.apple.com/documentation/appstoreserverapi/get-refund-history
5. 개발자 주도 환불 API 제한으로 인해 고객 직접 요청 방식 안내
   - 환불 요청 페이지: https://support.apple.com/en-us/HT204084
   - reportaproblem.apple.com을 통한 환불 요청
   - StoreKit의 beginRefundRequest API 사용 (iOS 15.0+)
   - 참고 문서: https://developer.apple.com/documentation/storekit/transaction/beginrefundrequest(in:)-9k0pj
6. 고객이 애플에 직접 환불 요청 또는 앱 내에서 환불 요청
7. 애플에서 환불 검토 후 처리 완료

**처리 시간**: 24-48시간 (고객 직접 요청 시)  
**중요 사항**:
- App Store는 개발자 주도 환불 API가 매우 제한적
- 대부분의 환불은 고객이 애플에 직접 요청하는 방식
- 개발자는 환불 상태를 추적하기 어려움

---

## 4. 정산 데이터 조회 플로우

### 4.1 Google Play (AOS) 정산 조회

1. 정산 스케줄러가 정기적으로 정산 데이터 수집 작업 실행
2. 구글 플레이 콘솔의 재무 보고서에서 수동으로 데이터 다운로드
   - 참고 문서: https://support.google.com/googleplay/android-developer/answer/6135870
3. CSV 형태의 정산 파일을 시스템에서 파싱
4. 매출, 수수료, 세금 등 정산 정보 추출
5. 내부 정산 데이터베이스에 저장
6. 정산 리포트 생성 및 관리자에게 알림

**주요 제한사항**:
- 구글 플레이는 정산 데이터 API가 제한적
- 대부분 구글 플레이 콘솔에서 수동 다운로드 필요
- 정산 데이터에 1-2일 지연 발생 가능

### 4.2 App Store (iOS) 정산 조회

1. 정산 스케줄러가 정기적으로 정산 데이터 수집 작업 실행
2. App Store Connect의 매출 동향 또는 재무 보고서에서 데이터 확인
   - 참고 문서: https://help.apple.com/app-store-connect/#/dev061e63923
3. 매출, 수수료, 세금 등 정산 정보를 수동으로 추출
4. 내부 정산 데이터베이스에 저장
5. 정산 리포트 생성 및 관리자에게 알림

**주요 제한사항**:
- App Store Connect에서 수동 확인 및 다운로드 필요
- API를 통한 자동 정산 데이터 수집이 제한적
- 정산 데이터 지연 (보통 1-2일)

---

## 5. 조정 (Reconciliation) 플로우

### 5.1 구독 상태 동기화

1. 조정 스케줄러가 정기적으로 구독 상태 동기화 작업 실행
2. 데이터베이스에서 활성 상태인 구독 목록 조회
3. 각 구독에 대해 플랫폼 API를 통해 실제 상태 확인
4. 플랫폼과 내부 데이터베이스 간 상태 차이 발견 시:
   - 구독 상태 업데이트
   - 상태 변경 이력 로깅
   - 필요시 관리자에게 알림
5. 동기화 결과 리포트 생성

### 5.2 결제 상태 검증

1. 조정 스케줄러가 정기적으로 결제 상태 검증 작업 실행
2. 미승인 결제 건들 조회
3. 24시간 이상 미승인 결제는 만료 처리
4. 3일 이상 처리되지 않은 환불 건 확인 후 관리자에게 알림
5. 플랫폼별 정책에 따른 자동 처리 또는 수동 개입 알림

### 5.3 데이터 일관성 검증

1. 정기적으로 데이터 일관성 검증 작업 실행
2. 구독-결제-환불 간 연관 관계 검증
3. 중복 데이터 또는 고아 데이터 탐지
4. 데이터 불일치 발견 시 자동 수정 또는 관리자 알림
5. 검증 결과 리포트 생성

---

## 주요 주의사항 및 참고사항

### Google Play 특이사항
1. **승인 필수 처리**: 구매 후 3일 이내 승인하지 않으면 자동 환불됨
2. **OAuth 2.0 인증**: Google Cloud Console에서 서비스 계정 JSON 키 생성 필요
3. **패키지명 정확성**: 앱의 정확한 패키지명 사용 필수
4. **구독 상태 매핑**: 구글의 상태 코드를 내부 상태로 정확히 변환 필요
5. **API 제한**: 분당 요청 수 제한 고려한 호출 패턴 설계

### App Store 특이사항  
1. **JWT 토큰 관리**: App Store Connect에서 생성한 JWT 토큰의 만료 관리
2. **번들 ID 정확성**: 앱의 정확한 번들 ID 사용 필수
3. **환불 제한**: 개발자 주도 환불이 제한적이므로 고객 직접 요청 안내
4. **환경 구분**: 샌드박스와 프로덕션 환경별 다른 API 엔드포인트 사용
5. **영수증 검증**: 클라이언트와 서버 양쪽에서 영수증 검증 필요

### 공통 주의사항
1. **API 호출 제한**: 각 플랫폼의 API 호출 제한 정책 준수
2. **에러 핸들링**: 네트워크 오류, 인증 실패 등에 대한 적절한 재시도 로직 구현
3. **보안**: API 키, 토큰 등 민감 정보의 안전한 환경변수 관리
4. **로깅**: 모든 외부 API 호출과 결과에 대한 상세 로깅
5. **테스트**: 실제 서비스 전 샌드박스/테스트 환경에서 충분한 검증
6. **모니터링**: 결제 실패, 환불 지연 등에 대한 실시간 모니터링 구축
7. **백업**: 중요한 거래 데이터의 정기적 백업 및 복구 계획 수립