# IAP Integration 도메인 모델

## 1. Member (회원)
**분류**: Entity

**비즈니스 설명**: 구독 서비스를 이용하는 사용자 정보

**속성**:
- 회원 식별자 (id)
- 이메일 (email)
- 패스워드 (password)

**비즈니스 규칙**:
- 한 명의 회원은 여러 구독을 가질 수 있음
- 회원 식별자는 고유해야 함

---

## 2. Subscription (구독 상품)
**분류**: Entity

**비즈니스 설명**: 구독 서비스에서 제공하는 상품 정보. 실제 회원의 구독과는 별개의 상품 정의

**속성**:
- 구독 상품 식별자 (id)
- 상품명 (name)
- 월 요금 (pricePerMonth) - 단위: 원
- 상품 설명 (description)
- 대여 기간 (rentalPeriod) - 단위: 일
- 구독 기간 (subscriptionPeriod) - 단위: 일
- 하루 시리즈 대여 개수 (seriesRentalCountPerDay)
- 퀘스트 개수 (questCount)
- 리워드 (reward)
- 노출 여부 (displayable)

**비즈니스 규칙**:
- 구독 상품은 플랫폼의 productId와 매핑됨
- 노출되는 상품만 구매 가능
- 상품별로 제공되는 혜택이 다름

---

## 3. MemberSubscription (회원 구독)
**분류**: Aggregate Root

**비즈니스 설명**: 특정 회원이 특정 구독 상품을 구독하는 정보. 실제 구독 관리의 핵심

**속성**:
- 회원 구독 식별자 (id)
- 회원 (member)
- 구독 상품 (subscription)
- 결제 정보 (payment)
- 구독 시작일시 (startDateTime)
- 구독 종료일시 (endDateTime)
- 구독 상태 (status)
- 구매 토큰 (purchaseToken)
- 상품 식별자 (productId)

**행위**:
- 다음 결제일 조회 (getNextPaymentDate)
- 활성 상태 확인 (isActive)
- 만료 상태 확인 (isExpired)
- 구독 취소 (cancel)

**비즈니스 규칙**:
- 활성 구독만 서비스 이용 가능
- 구독 취소 시에도 종료일까지 이용 가능
- 한 회원은 동시에 하나의 활성 구독만 가능
- 구매 토큰은 중복될 수 없음

---

## 4. MemberSubscriptionStatus (회원 구독 상태)
**분류**: Value Object

**비즈니스 설명**: 회원 구독의 현재 상태를 나타내는 값

**속성**:
- 활성 (ACTIVE): 정상 이용 중
- 취소됨 (CANCELLED): 사용자가 취소했으나 만료일까지 이용 가능
- 결제 전 (BEFORE_PAID): 검증은 완료되었으나 아직 지급 완료 전
- 만료됨 (EXPIRED): 구독 기간이 끝남

**비즈니스 규칙**:
- ACTIVE 상태만 서비스 이용 가능
- BEFORE_PAID 상태는 일시적이며, 빠르게 ACTIVE로 전환되어야 함
- CANCELLED 상태에서도 종료일까지는 서비스 이용 가능

---

## 5. Platform (플랫폼)
**분류**: Value Object

**비즈니스 설명**: 앱 내 구매가 이루어지는 플랫폼을 구분하는 값

**속성**:
- 구글 플레이스토어 (GOOGLE_PLAY)
- 애플 앱스토어 (APP_STORE)

**행위**:
- 플랫폼 타입 확인

**비즈니스 규칙**:
- 구독 상품은 플랫폼에 따라 다른 검증 방식을 사용해야 함
- 각 플랫폼은 고유한 API 스펙과 정책을 가짐

---

## 6. Payment (결제)
**분류**: Aggregate Root

**비즈니스 설명**: 사용자가 특정 상품에 대해 실제로 지불한 결제 건. 회원 구독과 연결됨

**속성**:
- 결제 식별자 (id)
- 구독 식별자 (subscriptionId)
- 사용자 식별자 (userId)
- 플랫폼 (platform)
- 주문 번호 (orderId)
- 거래 번호 (transactionId)
- 구매 토큰 (purchaseToken)
- 상품 식별자 (productId)
- 결제 금액 (amount)
- 통화 (currency)
- 결제 상태 (status)
- 결제 완료 시각 (paymentDate)
- 승인 상태 (acknowledgmentState)

**행위**:
- 결제 승인 (acknowledge)
- 환불 처리 (refund)
- 성공 상태 확인 (isSuccess)

**비즈니스 규칙**:
- 결제는 플랫폼에서 승인되어야 정상적으로 처리됨
- Google Play는 3일 이내 미승인 시 자동 환불
- App Store는 검증 즉시 자동 승인
- 결제 정보는 회원 구독과 1:1 관계

---

## 4. Refund (환불)
**분류**: Aggregate Root

**비즈니스 설명**: 이미 완료된 결제에 대한 환불 요청 및 처리

**속성**:
- 환불 식별자 (id)
- 결제 식별자 (paymentId)
- 구독 식별자 (subscriptionId)
- 사용자 식별자 (userId)
- 플랫폼 (platform)
- 환불 금액 (amount)
- 통화 (currency)
- 환불 사유 (reason)
- 환불 상태 (status)
- 요청 시각 (requestedAt)
- 처리 시각 (processedAt)
- 승인자 (approvedBy)
- 고객 메모 (customerNote)
- 내부 메모 (internalNote)
- 플랫폼 환불 식별자 (platformRefundId)

**행위**:
- 환불 승인 (approve)
- 환불 거부 (reject)
- 환불 완료 처리 (complete)
- 환불 실패 처리 (fail)

**비즈니스 규칙**:
- 환불 요청은 승인 후 처리됨
- 거부된 환불은 더 이상 처리할 수 없음
- 환불 완료 시 원 결제 건은 환불된 상태로 변경
- 플랫폼별로 환불 처리 시간과 방식이 다름
- 고객 사유와 시스템 사유로 구분하여 관리

---

## 5. SubscriptionStatus (구독 상태)
**분류**: Value Object

**비즈니스 설명**: 구독의 현재 상태를 나타내는 값

**속성**:
- 활성 (ACTIVE): 정상 이용 중
- 취소됨 (CANCELED): 사용자가 취소했으나 만료일까지 이용 가능
- 만료됨 (EXPIRED): 구독 기간이 끝남
- 보류 중 (ON_HOLD): 결제 문제로 일시 중단
- 유예 기간 (IN_GRACE_PERIOD): 결제 실패 후 재시도 대기
- 일시 정지 (PAUSED): 사용자가 일시 정지

**비즈니스 규칙**:
- 활성 상태만 서비스 이용 가능
- 유예 기간 중에는 제한적 서비스 제공
- 보류 상태는 결제 문제 해결 시 자동 복원

---

## 6. PaymentStatus (결제 상태)  
**분류**: Value Object

**비즈니스 설명**: 개별 결제의 처리 상태를 나타내는 값

**속성**:
- 결제 완료 (COMPLETED): 정상적으로 결제됨
- 승인됨 (ACKNOWLEDGED): 플랫폼에서 승인 처리됨
- 환불됨 (REFUNDED): 전액 또는 일부 환불됨

**비즈니스 규칙**:
- 완료된 결제만 승인 처리 가능
- 승인된 결제만 정상 결제로 인정
- 환불된 결제는 구독 상태에 영향을 줄 수 있음

---

## 7. RefundStatus (환불 상태)
**분류**: Value Object

**비즈니스 설명**: 환불 요청의 처리 진행 상태를 나타내는 값

**속성**:
- 요청됨 (REQUESTED): 환불 요청 접수
- 승인 대기 (PENDING_APPROVAL): 관리자 검토 필요
- 승인됨 (APPROVED): 환불 승인, 처리 대기
- 처리 중 (PROCESSING): 플랫폼에서 환불 처리 중
- 완료됨 (COMPLETED): 환불 완료
- 실패함 (FAILED): 환불 처리 실패
- 거부됨 (REJECTED): 환불 요청 거부

**비즈니스 규칙**:
- 승인된 환불만 처리 가능
- 거부된 환불은 재처리할 수 없음
- 실패한 환불은 재시도 가능

---

## 8. RefundReason (환불 사유)
**분류**: Value Object

**비즈니스 설명**: 환불 요청의 사유를 분류하는 값

**속성**:
- 고객 요청 (CUSTOMER_REQUEST): 단순 고객 변심
- 기술적 문제 (TECHNICAL_ISSUE): 서비스 오류
- 중복 결제 (DUPLICATE_PAYMENT): 실수로 중복 결제
- 서비스 불만 (SERVICE_DISSATISFACTION): 서비스 품질 불만
- 기타 (OTHER): 기타 사유

**비즈니스 규칙**:
- 사유별로 환불 승인 기준이 다를 수 있음
- 기술적 문제는 우선적으로 처리
- 고객 요청은 정책에 따라 선별적 승인

---

## 도메인 관계도

```
Member (Entity)
└── 회원 기본 정보

Subscription (Entity) - 구독 상품
├── 상품 정보 및 혜택
└── productId와 플랫폼 매핑

MemberSubscription (Aggregate Root) - 회원 구독
├── Member (Entity) - 구독하는 회원
├── Subscription (Entity) - 구독 상품
├── Payment (Aggregate Root) - 결제 정보
├── MemberSubscriptionStatus (Value Object) - 구독 상태
└── 구독 관리 비즈니스 로직

Payment (Aggregate Root)
├── Platform (Value Object)
├── PaymentStatus (Value Object)
└── 결제 비즈니스 로직

Refund (Aggregate Root)
├── Payment 참조 (특정 결제에 대한 환불)
├── MemberSubscription 참조 (옵션, 회원 구독 환불의 경우)
├── Platform (Value Object)
├── RefundStatus (Value Object)
├── RefundReason (Value Object)
└── 환불 비즈니스 로직
```

**애그리거트 간 관계**:
- Member ↔ MemberSubscription: 1대N 관계 (한 회원이 여러 구독을 가질 수 있음)
- Subscription ↔ MemberSubscription: 1대N 관계 (하나의 구독 상품으로 여러 회원이 구독 가능)
- Payment ↔ MemberSubscription: 1대1 관계 (하나의 회원 구독에 하나의 결제)
- Refund → Payment: 강한 참조 관계 (환불은 항상 특정 결제에 대함)
- Refund → MemberSubscription: 약한 참조 관계 (구독 환불의 경우에만)

**핵심 비즈니스 프로세스**:
1. **구독 검증 및 생성**: 
   - 플랫폼별 구독 정보 확인 및 검증
   - MemberSubscription 생성 (BEFORE_PAID 상태)
   
2. **결제 승인 및 활성화**: 
   - 구독에 대한 결제 완료 처리
   - MemberSubscription 상태를 ACTIVE로 변경
   
3. **회원 구독 관리**: 
   - 활성 구독 조회 및 혜택 제공
   - 구독 취소 및 만료 처리
   
4. **환불 처리**: 환불 요청부터 완료까지의 전체 프로세스
5. **정산**: 플랫폼별 매출 정산 및 수수료 처리
6. **조정**: 구독과 결제 상태 간의 일관성 유지

**주요 변경 사항**:
- 기존 Subscription을 구독 상품(Subscription)과 회원 구독(MemberSubscription)으로 분리
- 회원(Member) 엔티티 추가로 명확한 회원 관리
- 구독 상태를 MemberSubscriptionStatus로 분리하여 더 명확한 상태 관리
- 결제 검증 후 즉시 MemberSubscription 생성하여 중복 방지 및 추적 용이

---

## 9. Settlement (정산)
**분류**: Entity

**비즈니스 설명**: 플랫폼별 매출 정산 정보를 관리하는 엔티티

**속성**:
- id: 정산 고유 식별자
- platform: 정산 대상 플랫폼 (Google Play, App Store)
- settlementDate: 정산 기준일 (LocalDate)
- totalRevenue: 총 매출액 (BigDecimal)
- platformFee: 플랫폼 수수료 (BigDecimal)
- netRevenue: 순매출액 (총매출 - 수수료) (BigDecimal)
- currency: 통화 코드
- paymentCount: 결제 건수
- refundCount: 환불 건수
- refundAmount: 환불 금액 (BigDecimal)
- status: 정산 상태 (SettlementStatus)
- createdAt: 생성일시 (LocalDateTime)
- updatedAt: 수정일시 (LocalDateTime)

**비즈니스 규칙**:
- 일별 정산 데이터 생성 및 관리
- 플랫폼 수수료 자동 계산 (Google: 15%/30%, Apple: 15%/30%)
- 순매출 = 총매출 - 플랫폼수수료 - 환불금액
- 정산 데이터는 플랫폼 보고서와 일치해야 함
- 월별/연별 집계 데이터 제공

---

## 10. SettlementStatus (정산 상태)
**분류**: Value Object

**비즈니스 설명**: 정산 처리의 진행 상태를 나타내는 값

**속성**:
- 대기 중 (PENDING): 정산 데이터 수집 대기
- 처리 중 (PROCESSING): 정산 계산 및 검증 진행
- 완료됨 (COMPLETED): 정산 완료
- 실패함 (FAILED): 정산 처리 실패
- 분쟁 중 (DISPUTED): 플랫폼과 데이터 불일치로 분쟁 상태

**비즈니스 규칙**:
- 완료된 정산은 수정 불가
- 실패한 정산은 재처리 가능
- 분쟁 중인 정산은 수동 해결 필요

---

## 11. ReconciliationRecord (대사 기록)
**분류**: Entity

**비즈니스 설명**: 내부 시스템과 플랫폼 데이터 간의 대사 처리 결과를 기록하는 엔티티

**속성**:
- id: 대사 기록 고유 식별자
- platform: 대사 대상 플랫폼 (Google Play, App Store)
- reconciliationDate: 대사 기준일 (LocalDate)
- internalTransactionCount: 내부 시스템 거래 건수
- externalTransactionCount: 플랫폼 거래 건수
- internalAmount: 내부 시스템 거래 금액 (BigDecimal)
- externalAmount: 플랫폼 거래 금액 (BigDecimal)
- discrepancyCount: 불일치 건수
- discrepancyAmount: 불일치 금액 (BigDecimal)
- currency: 통화 코드
- status: 대사 상태 (ReconciliationStatus)
- notes: 대사 처리 메모
- createdAt: 생성일시 (LocalDateTime)
- updatedAt: 수정일시 (LocalDateTime)

**비즈니스 규칙**:
- 일별 자동 대사 처리 수행
- 불일치 발견 시 상세 분석 및 조치 필요
- 대사 결과는 감사 추적을 위해 영구 보관
- 연속적인 불일치 발생 시 알림 발송
- 월별/분기별 대사 요약 보고서 생성

---

## 12. ReconciliationStatus (대사 상태)
**분류**: Value Object

**비즈니스 설명**: 대사 처리의 상태를 나타내는 값

**속성**:
- 대기 중 (PENDING): 대사 처리 대기
- 진행 중 (IN_PROGRESS): 대사 처리 진행
- 일치함 (MATCHED): 내부와 외부 데이터 일치
- 불일치 발견 (DISCREPANCY_FOUND): 데이터 불일치 발견
- 해결됨 (RESOLVED): 불일치 해결 완료
- 실패함 (FAILED): 대사 처리 실패

**비즈니스 규칙**:
- 일치 상태는 추가 조치 불필요
- 불일치 발견 시 원인 분석 및 조치 필요
- 해결된 대사는 재처리 불가
- 실패한 대사는 재시도 가능